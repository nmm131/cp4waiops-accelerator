# *************************************************************************************************************************************************
# --------------------------------------------------------------------------------------------------------------------------------------
# Install ServiceMesh/Istio
# --------------------------------------------------------------------------------------------------------------------------------------
# *************************************************************************************************************************************************
    

- name: ISTIO -              ðŸ”Ž Check ServiceMesh Installed
  k8s_info:
    kind: Deployment
    name: kiali
    namespace: istio-system
  register: K8S_EXISTS

# --------------------------------------------------------------------------------------------------------------------------------------
# Install Service Mesh Operators
# --------------------------------------------------------------------------------------------------------------------------------------
- name: ISTIO -            ðŸš€ Create openshift-operators-redhat Namespace
  community.kubernetes.k8s:
    api_version: v1
    kind: Namespace
    name: openshift-operators-redhat
    state: present
  when: K8S_EXISTS.resources|length == 0


- name: ISTIO -            ðŸš€ Install Elasticsearch Operator
  community.kubernetes.k8s:
    state: present
    template: ./templates/istio/sub-elasticsearch.yaml
  when: K8S_EXISTS.resources|length == 0


- name: ISTIO -            ðŸš€ Install Jaeger Operator
  community.kubernetes.k8s:
    state: present
    template: ./templates/istio/sub-jaeger.yaml
  when: K8S_EXISTS.resources|length == 0


- name: ISTIO -            ðŸš€ Install Kiali Operator
  community.kubernetes.k8s:
    state: present
    template: ./templates/istio/sub-kiali.yaml
  when: K8S_EXISTS.resources|length == 0


- name: ISTIO -            ðŸš€ Install Service Mesh Operator
  community.kubernetes.k8s:
    state: present
    template: ./templates/istio/sub-servicemesh.yaml
  when: K8S_EXISTS.resources|length == 0


# --------------------------------------------------------------------------------------------------------------------------------------
# Install Service Mesh Instance
# --------------------------------------------------------------------------------------------------------------------------------------
- name: ISTIO -            ðŸš€ Create istio-system Namespace
  community.kubernetes.k8s:
    api_version: v1
    kind: Namespace
    name: istio-system
    state: present
  when: K8S_EXISTS.resources|length == 0


- name: ISTIO -            ðŸš€ Install Service Mesh CR
  community.kubernetes.k8s:
    state: present
    namespace: istio-system
    template: ./templates/istio/install-servicemesh.yaml
  when: K8S_EXISTS.resources|length == 0


- name: ISTIO -            ðŸš€ Install Service Mesh Member Roll
  community.kubernetes.k8s:
    state: present
    namespace: istio-system
    template: ./templates/istio/install-service-member.yaml
  when: K8S_EXISTS.resources|length == 0



- name: CHECK -              ðŸ•¦ Wait for ServiceMesh to be ready
  shell: |
    KIALI_POD=$(oc get po -n istio-system | grep kiali)
    echo $KIALI_POD
  register: kubectl_kiali
  until: ("1/1" in kubectl_kiali.stdout)
  retries: 500
  delay: 15


# --------------------------------------------------------------------------------------------------------------------------------------
# Adapt Robot-Shop
# --------------------------------------------------------------------------------------------------------------------------------------
- name: ISTIO -            ðŸš€ Install Robot-Shop Gateway
  community.kubernetes.k8s:
    state: present
    namespace: istio-system
    template: ./templates/demo_apps/robotshop/istio/gateway.yaml
  #when: K8S_EXISTS.resources|length == 0


- name: ISTIO -            ðŸš€ Install Robot-Shop Ratings Staging Test
  community.kubernetes.k8s:
    state: present
    namespace: robot-shop
    template: ./templates/demo_apps/robotshop/istio/ratings-staging.yaml
  #when: K8S_EXISTS.resources|length == 0


- name: ISTIO -            ðŸš€ Install Robot-Shop VirtualService all traffic to test Pod
  community.kubernetes.k8s:
    state: present
    namespace: istio-system
    template: ./templates/demo_apps/robotshop/istio/canary-0-100.yaml
  #when: K8S_EXISTS.resources|length == 0